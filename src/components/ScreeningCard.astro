---
import type { Screening } from '../types';
import type { Language } from '../i18n/translations';
import { t } from '../i18n/translations';

interface Props {
  screening: Screening;
  lang: Language;
  index?: number;
}

const { screening, lang, index = 0 } = Astro.props;

// Get localized content (fall back to Turkish if English not available)
const note = lang === 'en' 
  ? (screening.programmersNoteEn || screening.programmersNote) 
  : screening.programmersNote;
const synopsis = lang === 'en' 
  ? (screening.synopsisEn || screening.synopsis) 
  : screening.synopsis;

const hasExpandedContent = note || synopsis;
const cardId = `screening-${screening.id}`;

// Translate special values
const displayTime = !screening.time || screening.time.trim() === ''
  ? t(lang, 'screening.allDay')
  : screening.time === 'Farklı Saatler' 
    ? t(lang, 'screening.variousTimes')
    : screening.time;

const displayVenue = screening.venue === 'Farklı Mekanlar'
  ? t(lang, 'screening.variousVenues')
  : screening.venue;

// Use English title if available and language is English, otherwise use Turkish
const displayTitle = (lang === 'en' && screening.filmTitleEn) 
  ? screening.filmTitleEn 
  : screening.filmTitle;
---

<article 
  class:list={[
    "screening-card animate-fade-in group relative",
    { "screening-card-featured": note }
  ]}
  style={`animation-delay: ${index * 0.05}s`}
  data-expandable={hasExpandedContent ? 'true' : 'false'}
  data-venue-id={screening.venueId}
>
  <!-- Cereyan Selects star indicator -->
  {note && (
    <div class="absolute top-3 right-3" title={t(lang, 'screening.cereyanTake')}>
      <svg class="w-5 h-5" fill="#B8860B" stroke="#B8860B" stroke-width="1" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
      </svg>
    </div>
  )}
  
  <!-- Top gradient accent bar -->
  <div class="screening-card-accent"></div>
  
  <!-- Card content -->
  <div class="screening-card-content">
    <!-- Time badge -->
    <div class="flex justify-center mb-4">
      <span class="time-badge">
        {displayTime}
      </span>
    </div>
    
    <!-- Date range info (if applicable) -->
    {(screening.isDateRange || screening.isUntilDate) && (
      <div class="text-center mb-3">
        {screening.isDateRange && (
          <span class="text-xs text-text-muted">
            {screening.dateDisplay}
          </span>
        )}
        {screening.isUntilDate && (
          <span class="text-xs text-text-muted">
            {t(lang, 'screening.until')}
          </span>
        )}
      </div>
    )}

    <!-- Film title -->
    <h3 class="font-display font-semibold text-2xl sm:text-3xl leading-tight text-center mb-2">
      {screening.link ? (
        <a 
          href={screening.link}
          target="_blank"
          rel="noopener noreferrer"
          class="text-text hover:text-cereyan-pink transition-colors underline decoration-cereyan-pink/40 underline-offset-2 hover:decoration-cereyan-pink"
        >
          {displayTitle}
        </a>
      ) : (
        <span class="text-text">{displayTitle}</span>
      )}
    </h3>
    
    <!-- Director, Year, Runtime -->
    {(screening.director || screening.year || screening.runtime) && (
      <p class="text-sm text-text-muted text-center mb-5">
        {[
          screening.director,
          screening.year,
          screening.runtime && `${screening.runtime} ${lang === 'tr' ? 'dk' : 'min'}`
        ].filter(Boolean).join(' • ')}
      </p>
    )}
    
    <!-- Venue and Event Series tags -->
    <div class="flex flex-wrap items-center justify-center gap-2 mb-2">
      <span class="venue-tag">
        {displayVenue}
      </span>
      {screening.eventSeries && (
        <span class="event-tag">
          {screening.eventSeries}
        </span>
      )}
    </div>

    <!-- Expandable content -->
    {hasExpandedContent && (
      <div 
        id={cardId}
        class="expandable-content hidden mt-4 pt-4 border-t border-border text-center"
      >
        {note && (
          <div class="mb-3">
            <h4 class="text-xs font-semibold uppercase tracking-wider text-cereyan-pink mb-2">
              {t(lang, 'screening.cereyanTake')}
            </h4>
            <p class="text-sm text-text-muted leading-relaxed max-w-prose mx-auto">
              {note}
            </p>
          </div>
        )}
        
        {synopsis && (
          <div>
            <h4 class="text-xs font-semibold uppercase tracking-wider text-text-muted mb-2">
              {t(lang, 'screening.synopsis')}
            </h4>
            <p class="text-sm text-text-muted leading-relaxed max-w-prose mx-auto">
              {synopsis}
            </p>
          </div>
        )}
      </div>
    )}

    <!-- Action row (only shown if there's expandable content) -->
    {hasExpandedContent && (
      <div class="flex items-center justify-center mt-5 pt-4 border-t border-border-light">
        <button 
          class="expand-btn text-xs font-medium text-cereyan-pink hover:text-cereyan-pink-dark transition-colors flex items-center gap-1.5 px-2 py-1 rounded hover:bg-cereyan-pink/10"
          data-target={cardId}
          aria-expanded="false"
        >
          <svg class="w-4 h-4 expand-icon transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
          <span class="expand-text">{t(lang, 'screening.cereyanTake')}</span>
        </button>
      </div>
    )}
  </div>
</article>

<script>
  // Handle expand/collapse
  document.querySelectorAll('.expand-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.getAttribute('data-target');
      const content = document.getElementById(targetId!);
      const isExpanded = btn.getAttribute('aria-expanded') === 'true';
      
      if (content) {
        content.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', (!isExpanded).toString());
        
        // Rotate icon
        const icon = btn.querySelector('.expand-icon');
        if (icon) {
          icon.classList.toggle('rotate-180');
        }
      }
    });
  });
</script>
