---
import type { Screening } from '../types';
import type { Language } from '../i18n/translations';
import { t } from '../i18n/translations';

interface Props {
  screening: Screening;
  lang: Language;
  index?: number;
}

const { screening, lang, index = 0 } = Astro.props;

// Get localized content (fall back to Turkish if English not available)
const note = lang === 'en' 
  ? (screening.programmersNoteEn || screening.programmersNote) 
  : screening.programmersNote;
const synopsis = lang === 'en' 
  ? (screening.synopsisEn || screening.synopsis) 
  : screening.synopsis;

const hasExpandedContent = note || synopsis;
const cardId = `screening-${screening.id}`;
---

<article 
  class="screening-card animate-fade-in group"
  style={`animation-delay: ${index * 0.05}s`}
  data-expandable={hasExpandedContent ? 'true' : 'false'}
  data-venue-id={screening.venueId}
>
  <!-- Main content - always visible -->
  <div class="flex items-start justify-between gap-4">
    <div class="flex-1 min-w-0">
      <!-- Film title -->
      <h3 class="font-display font-semibold text-xl sm:text-2xl leading-tight">
        {screening.link ? (
          <a 
            href={screening.link}
            target="_blank"
            rel="noopener noreferrer"
            class="text-text hover:text-cereyan-pink transition-colors"
          >
            {screening.filmTitle}
          </a>
        ) : (
          <span class="text-text">{screening.filmTitle}</span>
        )}
      </h3>
      
      <!-- Venue and Event Series -->
      <div class="flex flex-wrap items-center gap-2 mt-2">
        <span class="venue-tag">
          {screening.venue}
        </span>
        {screening.eventSeries && (
          <span class="event-tag">
            {screening.eventSeries}
          </span>
        )}
      </div>
    </div>

    <!-- Time -->
    <div class="flex flex-col items-end shrink-0">
      <span class="font-mono text-sm text-cereyan-pink font-medium">
        {screening.time}
      </span>
      {screening.isDateRange && (
        <span class="text-xs text-text-muted mt-1">
          {screening.dateDisplay}
        </span>
      )}
      {screening.isUntilDate && (
        <span class="text-xs text-text-muted mt-1">
          {t(lang, 'screening.until')}
        </span>
      )}
    </div>
  </div>

  <!-- Expandable content -->
  {hasExpandedContent && (
    <div 
      id={cardId}
      class="expandable-content hidden mt-4 pt-4 border-t border-border"
    >
      {note && (
        <div class="mb-3">
          <h4 class="text-xs font-semibold uppercase tracking-wider text-cereyan-pink mb-2">
            {t(lang, 'screening.cereyanTake')}
          </h4>
          <p class="text-sm text-text-muted leading-relaxed">
            {note}
          </p>
        </div>
      )}
      
      {synopsis && (
        <div>
          <h4 class="text-xs font-semibold uppercase tracking-wider text-text-muted mb-2">
            {t(lang, 'screening.synopsis')}
          </h4>
          <p class="text-sm text-text-muted leading-relaxed">
            {synopsis}
          </p>
        </div>
      )}
    </div>
  )}

  <!-- Action row -->
  <div class="flex items-center justify-between mt-4 pt-3 border-t border-border-light">
    {hasExpandedContent ? (
      <button 
        class="expand-btn text-xs text-text-muted hover:text-cereyan-pink transition-colors flex items-center gap-1"
        data-target={cardId}
        aria-expanded="false"
      >
        <svg class="w-4 h-4 expand-icon transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
        <span class="expand-text">{t(lang, 'screening.cereyanTake')}</span>
      </button>
    ) : (
      <div></div>
    )}
    
    {screening.link && (
      <a 
        href={screening.link}
        target="_blank"
        rel="noopener noreferrer"
        class="text-xs font-medium text-cereyan-pink hover:text-cereyan-pink-light transition-colors flex items-center gap-1"
      >
        {t(lang, 'screening.moreInfo')}
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
        </svg>
      </a>
    )}
  </div>
</article>

<script>
  // Handle expand/collapse
  document.querySelectorAll('.expand-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.getAttribute('data-target');
      const content = document.getElementById(targetId!);
      const isExpanded = btn.getAttribute('aria-expanded') === 'true';
      
      if (content) {
        content.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', (!isExpanded).toString());
        
        // Rotate icon
        const icon = btn.querySelector('.expand-icon');
        if (icon) {
          icon.classList.toggle('rotate-180');
        }
      }
    });
  });
</script>
