---
import type { Language } from '../i18n/translations';
import { t } from '../i18n/translations';

interface Week {
  id: string;
  label: string;
  labelEn: string;
  isCurrent: boolean;
  isPast: boolean;
}

interface Props {
  weeks: Week[];
  currentWeekId: string;
  lang: Language;
}

const { weeks, currentWeekId, lang } = Astro.props;
---

<div class="mb-8">
  <!-- Mobile: Dropdown -->
  <div class="sm:hidden">
    <label for="week-select" class="sr-only">{t(lang, 'calendar.selectWeek')}</label>
    <select 
      id="week-select"
      class="w-full bg-cinema-darker border border-cinema-gray rounded-lg px-4 py-3 text-cinema-text focus:border-cereyan-pink focus:outline-none focus:ring-1 focus:ring-cereyan-pink"
      onchange="window.location.href = this.value"
    >
      {weeks.map((week) => (
        <option 
          value={`?week=${week.id}`}
          selected={week.id === currentWeekId}
        >
          {lang === 'tr' ? week.label : week.labelEn}
          {week.isCurrent ? ` (${t(lang, 'calendar.thisWeek')})` : ''}
        </option>
      ))}
    </select>
  </div>

  <!-- Desktop: Horizontal tabs -->
  <div class="hidden sm:block overflow-x-auto scrollbar-hide">
    <div class="flex items-center gap-1 min-w-max pb-2">
        {weeks.map((week) => {
          const isCurrent = week.isCurrent;
          
          return (
            <a 
              href={`?week=${week.id}`} 
              class="relative px-4 py-2 text-sm font-medium rounded-lg transition-all whitespace-nowrap text-cinema-text-muted"
              data-week-tab
              data-week-id={week.id}
              data-is-current={isCurrent.toString()}
              data-is-past={week.isPast.toString()}
            >
              {lang === 'tr' ? week.label : week.labelEn}
              {/* Pulsing dot for current week - visibility controlled by JS */}
              {isCurrent && (
                <span class="week-dot absolute -top-1 -right-1 w-2.5 h-2.5 bg-cereyan-pink rounded-full animate-pulse ring-2 ring-cinema-black" style="display: none;"></span>
              )}
            </a>
          );
        })}
    </div>
  </div>

  <!-- Navigation arrows for context -->
  <div class="hidden sm:flex items-center justify-between mt-3 px-1">
    <button 
      onclick="document.querySelector('.overflow-x-auto').scrollBy({left: -200, behavior: 'smooth'})"
      class="text-cinema-text-muted hover:text-cereyan-pink transition-colors"
      aria-label={t(lang, 'calendar.previousWeek')}
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </button>
    
    <span class="text-xs text-cinema-text-muted uppercase tracking-wider">
      {t(lang, 'calendar.selectWeek')}
    </span>
    
    <button 
      onclick="document.querySelector('.overflow-x-auto').scrollBy({left: 200, behavior: 'smooth'})"
      class="text-cinema-text-muted hover:text-cereyan-pink transition-colors"
      aria-label={t(lang, 'calendar.nextWeek')}
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </button>
  </div>
</div>

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>

<script>
  // Handle week selection visual state client-side
  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const selectedWeek = urlParams.get('week');
    
    // Get all week tab links
    const weekTabs = document.querySelectorAll('[data-week-tab]');
    
    weekTabs.forEach(tab => {
      const weekId = tab.getAttribute('data-week-id');
      const isCurrent = tab.getAttribute('data-is-current') === 'true';
      const isSelected = selectedWeek ? weekId === selectedWeek : isCurrent;
      
      // Reset classes
      tab.className = 'relative px-4 py-2 text-sm font-medium rounded-lg transition-all whitespace-nowrap';
      
      if (isSelected) {
        // Selected: solid pink background
        tab.classList.add('bg-cereyan-pink', 'text-cinema-black', 'font-semibold');
        // Remove the pulsing dot if selected
        const dot = tab.querySelector('.week-dot');
        if (dot) dot.style.display = 'none';
      } else if (isCurrent) {
        // Current but not selected: pink ring + visible dot
        tab.classList.add('ring-2', 'ring-cereyan-pink/60', 'text-cereyan-pink', 'hover:bg-cereyan-pink/10');
        const dot = tab.querySelector('.week-dot');
        if (dot) dot.style.display = 'block';
      } else {
        // Past or future
        const isPast = tab.getAttribute('data-is-past') === 'true';
        if (isPast) {
          tab.classList.add('text-cinema-text-muted/50', 'hover:text-cinema-text-muted', 'hover:bg-cinema-gray/30');
        } else {
          tab.classList.add('text-cinema-text-muted', 'hover:text-cinema-text', 'hover:bg-cinema-gray/50');
        }
      }
    });
    
    // Also update the mobile dropdown
    const select = document.getElementById('week-select') as HTMLSelectElement;
    if (select && selectedWeek) {
      const option = select.querySelector(`option[value="?week=${selectedWeek}"]`) as HTMLOptionElement;
      if (option) option.selected = true;
    }
  });
</script>
